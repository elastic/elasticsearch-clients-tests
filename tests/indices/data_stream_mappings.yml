---
requires:
  serverless: true
  stack: true
---
teardown:
  - do:
      indices.delete_data_stream:
        name: mapping-ds-1
        ignore: 404
---
"Test data stream mappings":
  - do:
      indices.put_index_template:
        name: mappings-template
        body:
          index_patterns: [ mapping-ds-* ]
          data_stream: { }
          template:
            settings:
              number_of_replicas: 0
            mappings:
              properties:
                field1:
                  type: keyword

  - do:
      indices.create_data_stream:
        name: mapping-ds-1
  - do:
      cluster.health:
        index: "mapping-ds-1"
        wait_for_status: green
  - do:
      indices.get_data_stream_mappings:
        name: mapping-ds-1
  - match: { data_streams.0.name: mapping-ds-1 }
  - match: { data_streams.0.mappings: {} }
  - length: { data_streams.0.effective_mappings.properties: 1 }

  - do:
      indices.get_data_stream:
        name: mapping-ds-1
  - match: { data_streams.0.name: mapping-ds-1 }
  - match: { data_streams.0.mappings: {} }

  - do:
      indices.put_data_stream_mappings:
        name: mapping-ds-1
        body:
          properties:
            name:
              type: keyword
              fields:
                english:
                  type: text
  - match: { data_streams.0.name: mapping-ds-1 }
  - match: { data_streams.0.applied_to_data_stream: true }
  - match: { data_streams.0.mappings.properties.name.type: "keyword" }
  - match: { data_streams.0.effective_mappings.properties.name.type: "keyword" }

  - do:
      indices.rollover:
        alias: "mapping-ds-1"

  - do:
      cluster.health:
        index: "mapping-ds-1"
        wait_for_status: green

  - do:
      indices.get_data_stream_mappings:
        name: mapping-ds-1
  - match: { data_streams.0.name: mapping-ds-1 }
  - length: { data_streams.0.effective_mappings.properties: 2 }
  - match: { data_streams.0.mappings.properties.name.type: "keyword" }
  - match: { data_streams.0.effective_mappings.properties.name.type: "keyword" }

  - do:
      indices.get_data_stream:
        name: mapping-ds-1
  - match: { data_streams.0.name: mapping-ds-1 }
  - match: { data_streams.0.mappings.properties.name.type: "keyword" }
