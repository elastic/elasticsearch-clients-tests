---
requires:
  serverless: true
  stack: true
---
setup:
  - do:
      indices.put_index_template:
        name: options-template
        body:
          index_patterns: [ failure-data-stream ]
          data_stream: { }
          template:
            settings:
              number_of_replicas: 0
            data_stream_options:
              failure_store:
                enabled: true

  - do:
      indices.create_data_stream:
        name: failure-data-stream

  - do:
      indices.rollover:
        alias: "failure-data-stream::failures"

  - do:
      cluster.health:
        index: "failure-data-stream"
        wait_for_status: green
---
teardown:
  - do:
      indices.delete_data_stream:
        name: failure-data-stream
        ignore: 404
  - do:
      indices.delete_index_template:
        name: options-template
        ignore: 404
---
"Test data stream options":
  - do:
      indices.get_data_stream_options:
        name: "failure-data-stream"
  - match: { data_streams.0.name: failure-data-stream }
  - match: { data_streams.0.options.failure_store.enabled: true }

  - do:
      indices.put_data_stream_options:
        name: "failure-data-stream"
        body:
          failure_store:
            enabled: false
            lifecycle:
              data_retention: 30d
  - is_true: acknowledged

  - do:
      indices.get_data_stream_options:
        name: "failure-data-stream"
  - match: { data_streams.0.name: failure-data-stream }
  - match: { data_streams.0.options.failure_store.enabled: false }
  - is_false: data_streams.0.options.failure_store.enabled
  - match: { data_streams.0.options.failure_store.lifecycle.enabled: true }
  - match: { data_streams.0.options.failure_store.lifecycle.data_retention: 30d }

  - do:
      indices.delete_data_stream_options:
        name: "failure-data-stream"
  - is_true: acknowledged

  - do:
      indices.get_data_stream_options:
        name: "failure-data-stream"
  - match: { data_streams.0.name: failure-data-stream }
  - is_false: data_streams.0.options
